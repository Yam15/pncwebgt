import{a as l,b as y,f as I}from"./chunk-KT3CPUTC.js";var P=(e,n)=>n.some(t=>e instanceof t),B,b;function T(){return B||(B=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function x(){return b||(b=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var E=new WeakMap,D=new WeakMap,M=new WeakMap,h=new WeakMap,p=new WeakMap;function C(e){let n=new Promise((t,o)=>{let i=()=>{e.removeEventListener("success",a),e.removeEventListener("error",r)},a=()=>{t(c(e.result)),i()},r=()=>{o(e.error),i()};e.addEventListener("success",a),e.addEventListener("error",r)});return n.then(t=>{t instanceof IDBCursor&&E.set(t,e)}).catch(()=>{}),p.set(n,e),n}function S(e){if(D.has(e))return;let n=new Promise((t,o)=>{let i=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",r),e.removeEventListener("abort",r)},a=()=>{t(),i()},r=()=>{o(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",a),e.addEventListener("error",r),e.addEventListener("abort",r)});D.set(e,n)}var m={get(e,n,t){if(e instanceof IDBTransaction){if(n==="done")return D.get(e);if(n==="objectStoreNames")return e.objectStoreNames||M.get(e);if(n==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return c(e[n])},set(e,n,t){return e[n]=t,!0},has(e,n){return e instanceof IDBTransaction&&(n==="done"||n==="store")?!0:n in e}};function L(e){m=e(m)}function V(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(n,...t){let o=e.call(f(this),n,...t);return M.set(o,n.sort?n.sort():[n]),c(o)}:x().includes(e)?function(...n){return e.apply(f(this),n),c(E.get(this))}:function(...n){return c(e.apply(f(this),n))}}function j(e){return typeof e=="function"?V(e):(e instanceof IDBTransaction&&S(e),P(e,T())?new Proxy(e,m):e)}function c(e){if(e instanceof IDBRequest)return C(e);if(h.has(e))return h.get(e);let n=j(e);return n!==e&&(h.set(e,n),p.set(n,e)),n}var f=e=>p.get(e);function N(e,n,{blocked:t,upgrade:o,blocking:i,terminated:a}={}){let r=indexedDB.open(e,n),u=c(r);return o&&r.addEventListener("upgradeneeded",s=>{o(c(r.result),s.oldVersion,s.newVersion,c(r.transaction),s)}),t&&r.addEventListener("blocked",s=>t(s.oldVersion,s.newVersion,s)),u.then(s=>{a&&s.addEventListener("close",()=>a()),i&&s.addEventListener("versionchange",d=>i(d.oldVersion,d.newVersion,d))}).catch(()=>{}),u}var A=["get","getKey","getAll","getAllKeys","count"],W=["put","add","delete","clear"],w=new Map;function g(e,n){if(!(e instanceof IDBDatabase&&!(n in e)&&typeof n=="string"))return;if(w.get(n))return w.get(n);let t=n.replace(/FromIndex$/,""),o=n!==t,i=W.includes(t);if(!(t in(o?IDBIndex:IDBObjectStore).prototype)||!(i||A.includes(t)))return;let a=function(r,...u){return I(this,null,function*(){let s=this.transaction(r,i?"readwrite":"readonly"),d=s.store;return o&&(d=d.index(u.shift())),(yield Promise.all([d[t](...u),i&&s.done]))[0]})};return w.set(n,a),a}L(e=>y(l({},e),{get:(n,t,o)=>g(n,t)||e.get(n,t,o),has:(n,t)=>!!g(n,t)||e.has(n,t)}));export{N as a};
